<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Umkreissuche ‚Äì PoC v8</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root { --vh: 1vh; --border:#ddd; --muted:#666; }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    body{background:#fff;color:#111}

    #app{
      height:100dvh;
      height:calc(var(--vh)*100);
      display:grid;
      grid-template-columns:360px 1fr;
      grid-template-rows:1fr;
    }
    #sidebar{padding:12px;overflow:auto;border-right:1px solid var(--border);background:#fff}
    #map{width:100%;height:100%}
    .leaflet-container{height:100% !important;}

    fieldset{border:1px solid var(--border);border-radius:10px;margin:0 0 12px;padding:8px 10px 10px}
    legend{font-weight:700;padding:0 6px}
    label{display:block;margin:8px 0 4px;font-weight:600}
    input[type="text"],input[type="number"]{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);font-size:15px}
    input[type="range"]{width:100%}
    button{padding:9px 11px;border-radius:8px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer;font-weight:600}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted);font-size:.92em}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;margin-left:6px}
    .addr-list{margin:6px 0 0;padding-left:18px}
    .addr-list li{margin:6px 0;line-height:1.3}
    .inside{color:#0a7a0a;font-weight:700}
    .outside{color:#777}
    .error{color:#b00020;margin-top:6px}
    .hr{border-top:1px dashed var(--border);margin:10px 0}

    .quick{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
    .quick button{padding:6px 9px;border-radius:999px}

    /* Mobile Header */
    .mobile-header{display:none;align-items:center;justify-content:space-between;margin-bottom:8px}
    .mobile-title{font-weight:800;font-size:18px}

    .collapse-wrap{overflow:hidden;transition:max-height .3s ease}
    .collapsed .collapse-wrap{max-height:0 !important;padding:0 !important}
    .collapsed #sidebar{padding-bottom:0}

    @media (max-width:960px){
      #app{grid-template-columns:1fr;grid-template-rows:auto 1fr}
      #sidebar{border-right:none;border-bottom:1px solid var(--border)}
      .mobile-header{display:flex}
    }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="mobile-header">
      <div class="mobile-title">Umkreissuche</div>
      <button id="togglePanel">Panel einklappen</button>
    </div>

    <div id="panel" class="collapse-wrap">
      <fieldset>
        <legend>Umkreis</legend>
        <label for="radius">Radius (Kilometer)
          <span id="radiusValue" class="pill">10</span>
        </label>
        <input id="radius" type="range" min="1" max="150" step="1" value="10">
        <div class="quick">
          <button data-km="5">5 km</button><button data-km="10">10 km</button>
          <button data-km="25">25 km</button><button data-km="50">50 km</button>
          <button data-km="100">100 km</button><button data-km="150">150 km</button>
        </div>
        <label for="radiusNum" class="muted">Direkteingabe (km)</label>
        <input id="radiusNum" type="number" min="1" max="150" step="1" value="10">
        <div class="hr"></div>
        <button id="locateBtn">üìç Mein Standort</button>
        <div id="locMsg" class="muted"></div>
      </fieldset>

      <fieldset>
        <legend>Adressen</legend>
        <input id="newAddr" type="text" placeholder="Neue Adresse eingeben">
        <div class="row"><button id="addBtn">Adresse speichern</button><button id="clearBtn">Alles l√∂schen</button></div>
        <div id="addMsg" class="muted"></div>
        <div class="hr"></div>
        <div class="muted">Gespeicherte Adressen (<span id="addrCount">0</span>):</div>
        <ul id="addrList" class="addr-list"></ul>
      </fieldset>

      <fieldset>
        <legend>Treffer</legend>
        <div id="stats" class="muted">0 innerhalb ‚Ä¢ 0 au√üerhalb</div>
      </fieldset>

      <div id="error" class="error"></div>
    </div>
  </div>
  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const SEED_ADDRESSES = [
  "EZB-Turm, Sonnemannstra√üe 20, 60314 Frankfurt am Main",
  "Brandenburger Tor, Berlin","Marienplatz, M√ºnchen","Domplatz, K√∂ln","Neuer Wall 1, Hamburg"
];
const LS_KEYS = {ADDRS:"poc_umkreis_addresses_v1"};
const NOMINATIM_URL = "https://nominatim.openstreetmap.org/search";
const DEFAULT_CENTER = {lat:50.1109,lon:8.6821};
const DEFAULT_ZOOM = 12;

const $ = s => document.querySelector(s);
function uid(){return Math.random().toString(36).slice(2,10);}
function loadAddresses(){const raw=localStorage.getItem(LS_KEYS.ADDRS);return raw?JSON.parse(raw):[];}
function saveAddresses(l){localStorage.setItem(LS_KEYS.ADDRS,JSON.stringify(l));}
async function geocode(addr){
  const p=new URLSearchParams({q:addr,format:"jsonv2",limit:"1"});
  const r=await fetch(`${NOMINATIM_URL}?${p.toString()}`);const d=await r.json();
  if(!d[0]) throw new Error("Keine Treffer");return{lat:+d[0].lat,lon:+d[0].lon};
}

let map,markersLayer,userMarker,radiusCircle;
let center={...DEFAULT_CENTER};let userLocated=false;

function initMap(){
  map=L.map("map").setView([DEFAULT_CENTER.lat,DEFAULT_CENTER.lon],DEFAULT_ZOOM);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"¬© OSM"}).addTo(map);
  markersLayer=L.layerGroup().addTo(map);
  setCenterOnMap(center.lat,center.lon,true);
}
function setCenterOnMap(lat,lon,initial=false){
  if(!userMarker){userMarker=L.marker([lat,lon]).addTo(map).bindPopup(initial?"Startpunkt: Frankfurt":"Mein Standort");}
  else{userMarker.setLatLng([lat,lon]);userMarker.setPopupContent(initial?"Startpunkt: Frankfurt":"Mein Standort");}
  drawRadius(lat,lon,+$("#radius").value*1000);
}
function drawRadius(lat,lon,m){if(!radiusCircle){radiusCircle=L.circle([lat,lon],{radius:m,fillOpacity:0.1}).addTo(map);}else{radiusCircle.setLatLng([lat,lon]);radiusCircle.setRadius(m);}}

async function ensureSeedLoaded(){
  let list=loadAddresses();const exist=new Set(list.map(x=>x.address));
  for(const a of SEED_ADDRESSES){if(!exist.has(a)){try{const g=await geocode(a);list.push({id:uid(),address:a,...g});}catch(e){}}}
  saveAddresses(list);
}

function refresh(){
  const km=+$("#radius").value;$("#radiusValue").textContent=km;$("#radiusNum").value=km;
  setCenterOnMap(center.lat,center.lon,!userLocated);
  const list=loadAddresses();let inC=0,outC=0,inIds=new Set();
  for(const it of list){const d=map.distance([center.lat,center.lon],[it.lat,it.lon]);if(d<=km*1000){inC++;inIds.add(it.id);}else outC++;}
  markersLayer.clearLayers();
  for(const it of list){
    const m=L.circleMarker([it.lat,it.lon],{radius:6,color:inIds.has(it.id)?"#ff69b4":"#f00",weight:2});
    m.bindPopup(`<b>${it.address}</b>`);markersLayer.addLayer(m);}
  $("#addrCount").textContent=list.length;
  $("#addrList").innerHTML=list.map(it=>`<li>${inIds.has(it.id)?"‚óè":"‚óã"} ${it.address}</li>`).join("");
  $("#stats").textContent=`${inC} innerhalb ‚Ä¢ ${outC} au√üerhalb`;
}

window.addEventListener("DOMContentLoaded",async()=>{
  initMap();await ensureSeedLoaded();refresh();
  $("#radius").addEventListener("input",refresh);
  $("#radiusNum").addEventListener("change",()=>{$("#radius").value=$("#radiusNum").value;refresh();});
  document.querySelectorAll(".quick button").forEach(b=>b.addEventListener("click",()=>{$("#radius").value=b.dataset.km;refresh();}));
  $("#locateBtn").addEventListener("click",()=>{navigator.geolocation.getCurrentPosition(pos=>{center={lat:pos.coords.latitude,lon:pos.coords.longitude};userLocated=true;map.setView([center.lat,center.lon],13);refresh();},err=>{$("#locMsg").textContent="Fehler: "+err.message;});});
  $("#addBtn").addEventListener("click",async()=>{const addr=$("#newAddr").value.trim();if(!addr)return;try{const {lat,lon}=await geocode(addr);const l=loadAddresses();l.push({id:uid(),address:addr,lat,lon});saveAddresses(l);$("#newAddr").value="";refresh();}catch(e){$("#addMsg").textContent="Fehler: "+e.message;}});
  $("#clearBtn").addEventListener("click",()=>{if(confirm("Alles l√∂schen?")){saveAddresses([]);refresh();}});

  // Mobile Panel Toggle
  const toggle=$("#togglePanel"), sidebar=$("#sidebar");
  toggle.addEventListener("click",()=>{
    const c=sidebar.classList.contains("collapsed");
    if(c){sidebar.classList.remove("collapsed");toggle.textContent="Panel einklappen";}
    else{sidebar.classList.add("collapsed");toggle.textContent="Panel ausklappen";}
    setTimeout(()=>map.invalidateSize(),200);
  });
});
</script>
</body>
</html>
