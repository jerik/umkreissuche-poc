<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Umkreissuche ‚Äì PoC v5</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    :root { --vh: 1vh; --border: #ddd; --muted: #666; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: system-ui, sans-serif; }
    body { background:#fff; color:#111; }

    #app {
      height: 100dvh;
      height: calc(var(--vh) * 100);
      display: grid;
      grid-template-columns: 360px 1fr;
      grid-template-rows: 1fr;
    }

    #sidebar {
      padding: 12px; overflow: auto;
      border-right: 1px solid var(--border); background: #fff;
    }
    #map { width: 100%; height: 100%; }
    .leaflet-container { height: 100% !important; }

    fieldset { border: 1px solid var(--border); border-radius: 10px; margin: 0 0 12px; padding: 8px 10px 10px; }
    legend { font-weight: 700; padding: 0 6px; }
    label { display:block; margin: 8px 0 4px; font-weight: 600; }
    input[type="text"], input[type="number"] { width:100%; padding:10px; border-radius:8px; border:1px solid var(--border); font-size: 15px; }
    input[type="range"] { width:100%; }
    button { padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; background:#f7f7f7; font-weight:600; }
    .row { display: flex; gap: 8px; flex-wrap: wrap; }
    .muted { color: var(--muted); font-size: 0.9em; }
    .pill { display:inline-block; padding:2px 8px; border:1px solid var(--border); border-radius:999px; margin-left:6px; }
    .addr-list { margin:6px 0 0; padding-left: 18px; }
    .addr-list li { margin: 6px 0; line-height: 1.3; }
    .inside { color: #0a7a0a; font-weight: 700; }
    .outside { color: #777; }
    .error { color: #b00020; margin-top: 6px; }
    .hr { border-top:1px dashed var(--border); margin:10px 0; }

    @media (max-width: 960px) {
      #app { grid-template-columns: 1fr; grid-template-rows: auto 1fr; }
      #sidebar { border-right:none; border-bottom:1px solid var(--border); }
    }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <fieldset>
      <legend>Umkreis</legend>
      <label for="radius">Radius (Kilometer)
        <span id="radiusValue" class="pill">10</span>
      </label>
      <input id="radius" type="range" min="1" max="1000" step="1" value="10">
      <label for="radiusNum" class="muted">Direkteingabe (km)</label>
      <input id="radiusNum" type="number" min="1" max="1000" step="1" value="10">
      <div class="hr"></div>
      <button id="locateBtn">üìç Mein Standort</button>
      <div id="locMsg" class="muted"></div>
    </fieldset>

    <fieldset>
      <legend>Adressen</legend>
      <input id="newAddr" type="text" placeholder="Neue Adresse eingeben">
      <div class="row">
        <button id="addBtn">Adresse speichern</button>
        <button id="clearBtn">Alles l√∂schen</button>
      </div>
      <div id="addMsg" class="muted"></div>
      <div class="hr"></div>
      <div class="muted">Gespeicherte Adressen (<span id="addrCount">0</span>):</div>
      <ul id="addrList" class="addr-list"></ul>
    </fieldset>

    <fieldset>
      <legend>Treffer</legend>
      <div id="stats" class="muted">0 innerhalb ‚Ä¢ 0 au√üerhalb</div>
    </fieldset>

    <div id="error" class="error"></div>
  </div>

  <div id="map"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const SEED_ADDRESSES = [
  "EZB-Turm, Sonnemannstra√üe 20, 60314 Frankfurt am Main",
  "Brandenburger Tor, Berlin",
  "Marienplatz, M√ºnchen",
  "Domplatz, K√∂ln",
  "Neuer Wall 1, Hamburg"
];
const LS_KEYS = { ADDRS: "poc_umkreis_addresses_v1", USER: "poc_umkreis_user_v1" };
const NOMINATIM_URL = "https://nominatim.openstreetmap.org/search";
const DEFAULT_CENTER = { lat: 50.1109, lon: 8.6821 }; // Frankfurt
const DEFAULT_ZOOM = 12;

const $ = sel => document.querySelector(sel);
function uid() { return Math.random().toString(36).slice(2, 10); }

function loadAddresses(){ const raw=localStorage.getItem(LS_KEYS.ADDRS); return raw?JSON.parse(raw):[]; }
function saveAddresses(list){ localStorage.setItem(LS_KEYS.ADDRS, JSON.stringify(list)); }
function getUserLoc(){ const raw=localStorage.getItem(LS_KEYS.USER); return raw?JSON.parse(raw):null; }
function setUserLoc(lat, lon){ localStorage.setItem(LS_KEYS.USER, JSON.stringify({lat,lon})); }

async function geocode(address){
  const params=new URLSearchParams({q:address,format:"jsonv2",limit:"1"});
  const res=await fetch(`${NOMINATIM_URL}?${params.toString()}`);
  const data=await res.json(); if(!data[0]) throw new Error("keine Treffer");
  return {lat:+data[0].lat,lon:+data[0].lon};
}

let map,userMarker,radiusCircle,markersLayer;
function initMap(){
  map=L.map("map").setView([DEFAULT_CENTER.lat,DEFAULT_CENTER.lon],DEFAULT_ZOOM);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:19,attribution:"¬© OSM"}).addTo(map);
  markersLayer=L.layerGroup().addTo(map);
}

function setUserOnMap(lat,lon){
  if(!userMarker){userMarker=L.marker([lat,lon]).addTo(map).bindPopup("Mein Standort");}
  else userMarker.setLatLng([lat,lon]);
  drawRadius(lat,lon,+$("#radius").value*1000);
  map.setView([lat,lon],13);
}
function drawRadius(lat,lon,meters){
  if(!radiusCircle){radiusCircle=L.circle([lat,lon],{radius:meters,fillOpacity:0.1}).addTo(map);}
  else{radiusCircle.setLatLng([lat,lon]);radiusCircle.setRadius(meters);}
}

async function ensureSeedLoaded(){
  let list=loadAddresses();
  const existingAddrs=new Set(list.map(x=>x.address));
  for(const a of SEED_ADDRESSES){
    if(!existingAddrs.has(a)){
      try{const geo=await geocode(a);list.push({id:uid(),address:a,...geo});}
      catch(e){console.warn("Seed-Fehler",a,e);}
    }
  }
  saveAddresses(list);
}

function refresh(){
  const user=getUserLoc();
  const km=+$("#radius").value;
  $("#radiusValue").textContent=km;
  $("#radiusNum").value=km;
  if(user) setUserOnMap(user.lat,user.lon);
  const list=loadAddresses();
  let inCount=0,outCount=0,inRange=new Set();
  if(user){for(const it of list){const d=map.distance([user.lat,user.lon],[it.lat,it.lon]);
    if(d<=km*1000){inCount++;inRange.add(it.id);}else outCount++;}} else outCount=list.length;
  markersLayer.clearLayers();
  for(const it of list){
    const m=L.circleMarker([it.lat,it.lon],{radius:6,color:inRange.has(it.id)?"green":"#777"});
    m.bindPopup(it.address);markersLayer.addLayer(m);
  }
  $("#addrCount").textContent=list.length;
  $("#addrList").innerHTML=list.map(it=>`<li>${inRange.has(it.id)?"‚óè":"‚óã"} ${it.address}</li>`).join("");
  $("#stats").textContent=`${inCount} innerhalb ‚Ä¢ ${outCount} au√üerhalb`;
}

window.addEventListener("DOMContentLoaded",async()=>{
  initMap();
  await ensureSeedLoaded();
  const u=getUserLoc(); if(u) setUserOnMap(u.lat,u.lon);
  refresh();

  $("#radius").addEventListener("input",refresh);
  $("#radiusNum").addEventListener("change",()=>{$("#radius").value=$("#radiusNum").value;refresh();});

  $("#locateBtn").addEventListener("click",()=>{
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude,longitude}=pos.coords;setUserLoc(latitude,longitude);setUserOnMap(latitude,longitude);refresh();
    },err=>{$("#locMsg").textContent="Fehler: "+err.message;});
  });

  $("#addBtn").addEventListener("click",async()=>{
    const addr=$("#newAddr").value.trim(); if(!addr) return;
    try{const {lat,lon}=await geocode(addr);const list=loadAddresses();list.push({id:uid(),address:addr,lat,lon});saveAddresses(list);$("#newAddr").value="";refresh();}
    catch(e){$("#addMsg").textContent="Fehler: "+e.message;}
  });

  $("#clearBtn").addEventListener("click",()=>{if(confirm("Alles l√∂schen?")){saveAddresses([]);refresh();}});
});
</script>
</body>
</html>
